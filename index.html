<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- <link rel="stylesheet"href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"> -->
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
<link rel="stylesheet" href="style.css">

<meta name="viewport" content="initial-scale = 1.0, maximum-scale = 1.0, user-scalable = no, width = device-width, height = device-height">

<head>
  <title>Kordel</title>
</head>

<body class="mdc-typography mdc-theme--dark">
  <div class="mdc-toolbar mdc-toolbar--fixed">
    <div class="mdc-toolbar__row">
      <section class="mdc-toolbar__section mdc-toolbar__section--align-start">
        <button class="menu material-icons mdc-toolbar__icon--menu">menu</button>
        <span class="mdc-toolbar__title catalog-title">Kordel</span>
      </section>
      <section class="mdc-toolbar__section mdc-toolbar__section--align-end">
        <button class="material-icons mdc-toolbar__icon" id="updateButton" onclick='android.update("https://dl.dropbox.com/s/egp5yk0pe5ohvsk/index.html?dl=0","https://dl.dropbox.com/s/wnkniu2e5yz7tpy/style.css?dl=0");'>refresh</button>
        <button class="material-icons mdc-toolbar__icon musik" id="addRadioButton">add</button>
      </section>
    </div>

    <div class="mdc-toolbar__row musik tabs" id="music-tabs">
      <div class="mdc-toolbar__section">
        <nav class="mdc-tab-bar mdc-tab-bar--indicator-accent">
          <a class="mdc-tab mdc-tab--active" href="#one">Radio</a>
          <a class="mdc-tab" href="#two">Playlist</a>
          <span class="mdc-tab-bar__indicator"></span>
        </nav>
      </div>
    </div>
  </div>
  <!--Für Handys nur ein Temporärer Drawer der über den Menübutton eingeblendet wird-->
  <aside class="mdc-temporary-drawer">
    <nav class="mdc-temporary-drawer__drawer">
      <nav class="mdc-temporary-drawer__content mdc-list-group">
        <nav class="mdc-list">
          <a class="mdc-list-item musik" onclick='showPage("musik")'>
            <i class="material-icons mdc-list-item__start-detail">music_note</i>Musik
          </a>
          <a class="mdc-list-item" onclick=''>
            <i class="material-icons mdc-list-item__start-detail">local_movies</i>Filme
          </a>
          <a class="mdc-list-item Geraete" onclick='showPage("Geraete")'>
            <i class="material-icons mdc-list-item__start-detail">devices</i>Geräte
          </a>
        </nav>
      </nav>
    </nav>
  </aside>
  <!-- page enthält den permanenten Drawer und den content bereich nebeneinander -->
  <div id="page" class="mdc-toolbar-fixed-adjust mdc-typography mdc-theme--dark">
    <!--Für Tablets/PC Permanenter Drawer, da genug Platz ist-->
    <nav class="mdc-permanent-drawer">
      <nav class="mdc-list">
        <a class="mdc-list-item musik" onclick='showPage("musik")'>
          <i class="material-icons mdc-list-item__start-detail">music_note</i>Musik
        </a>
        <a class="mdc-list-item">
          <i class="material-icons mdc-list-item__start-detail">local_movies</i>Filme
        </a>
        <a class="mdc-list-item Geraete" onclick='showPage("Geraete")'>
          <i class="material-icons mdc-list-item__start-detail">devices</i>Geräte
        </a>
      </nav>
    </nav>

    <!-- content enthält die verschiedenen seiten (radio, filme, etc)-->
    <main id="content">

      <!-- RADIO + STREAMINGTOOLS -->
      <div class="contentpage musik">
        <div id="musik">
          <div id="sender"></div>
          <div id="playlist">
            <div class="mdc-switch">
              <input type="checkbox" id="onOffAutoplay" class="mdc-switch__native-control" checked/>
              <div class="mdc-switch__background">
                <div class="mdc-switch__knob"></div>
              </div>
            </div>
            <label class="geraetelabel">Autoplay</label>

          </div>
        </div>
      </div>

      <aside id="addRadiosenderDialog" class="mdc-dialog" role="alertdialog">
        <div class="mdc-dialog__surface">
          <header class="mdc-dialog__header">
            <h2 id="my-mdc-dialog-label" class="mdc-dialog__header__title">
              Radiosender hinzufügen
            </h2>
          </header>
          <section id="my-mdc-dialog-description" class="mdc-dialog__body">
            <div>
              <label>Name: </label>
              <label class="mdc-textfield mdc-textfield--upgraded" id="radionameinput">
                    <input type="text" class="mdc-textfield__input" id="radioname">
                </label>
            </div>
            <div>
              <label>http://</label>
              <label class="mdc-textfield mdc-textfield--upgraded" id="radiourlinput">
                    <input type="text" class="mdc-textfield__input" id="radiourl">
                </label>
            </div>


          </section>
          <footer class="mdc-dialog__footer">
            <button type="button" class="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--cancel">Abbrechen</button>
            <button type="button" class="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--accept">Speichern</button>
          </footer>
        </div>
        <div class="mdc-dialog__backdrop"></div>
      </aside>
      <aside id="removeRadiosenderDialog" class="mdc-dialog" role="alertdialog">
        <div class="mdc-dialog__surface">
          <header class="mdc-dialog__header">
            <h2 class="mdc-dialog__header__title">
              Radiosender löschen?
            </h2>
          </header>
          <section id="removeRadioBody" class="mdc-dialog__body">

          </section>
          <footer class="mdc-dialog__footer">
            <button type="button" class="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--cancel">Abbrechen</button>
            <button type="button" class="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--accept">Löschen</button>
          </footer>
        </div>
        <div class="mdc-dialog__backdrop"></div>
      </aside>

      <!-- GERÄTE -->
      <div id="Geraete" class="contentpage Geraete">
        <ul class="mdc-list">
          <h4 class="mdc-primary-on-background">Geräte starten und herunterfahren</h2>
            <li class="mdc-list-item">
              <div class="mdc-switch">
                <!-- onchange="onOffKordel(this)"  -->
                <input type="checkbox" id="onOffKordel" class="mdc-switch__native-control" checked/>
                <div class="mdc-switch__background">
                  <div class="mdc-switch__knob"></div>
                </div>
              </div>
              <label class="geraetelabel">Kordel</label>
            </li>
        </ul>
      </div>
    </main>

  </div>


  <div class="bottompanel">

    <div id="playlistcontrol" class="musik">

      <div id="playlistcontrol1">
        <div id="programselector">YT:</div>

        <div class="mdc-form-field playlistcontrolitem">
          <div class="mdc-checkbox">
            <input type="checkbox" id="video" class="mdc-checkbox__native-control" />
            <div class="mdc-checkbox__background">
              <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                <path class="mdc-checkbox__checkmark__path" fill="none" stroke="white" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
              </svg>
              <div class="mdc-checkbox__mixedmark"></div>
            </div>
          </div>
          <label class="checkbox-label" for="video">Video</label>
        </div>

        <div class="mdc-form-field playlistcontrolitem">
          <div class="mdc-checkbox">
            <input type="checkbox" id="next" class="mdc-checkbox__native-control" />
            <div class="mdc-checkbox__background">
              <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                <path class="mdc-checkbox__checkmark__path" fill="none" stroke="white" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
              </svg>
              <div class="mdc-checkbox__mixedmark"></div>
            </div>
          </div>
          <label class="checkbox-label" for="next">Als Nächstes</label>
        </div>
      </div>

      <div id="playlistcontrol2">
        <label class="mdc-textfield mdc-textfield--upgraded" id="songinput">
          <input type="text" class="mdc-textfield__input" id="song">
          <span class="mdc-textfield__label" id="songinputlabel" for="song">Song eingeben</span>
        </label>

        <button class="mdc-button" id="addtoPlaylistButton" onclick="addtoPlaylist()">
          <i class="material-icons">queue_music</i>
        </button>
      </div>

    </div>

    <div class="playercontrol">
      <button class="mdc-button playerbutton" onclick="stop();">
        <i class="material-icons">stop</i>
      </button>

      <div class="music-info">
        <div class="mdl-typography--font-bold">Song</div>
        <div>Interpret</div>
      </div>

      <!-- <button class="mdc-button playerbutton" onclick="playpause();" id="playpausebutton">
          <i class="material-icons">pause</i>
      </button> -->

      <i class="mdc-icon-toggle material-icons playerbutton" id="playpause" role="button" aria-pressed="false" data-toggle-on='{"content": "play_arrow"}' data-toggle-off='{"content": "pause"}'>
        pause
      </i>

      <!-- <button class="mdl-button mdl-js-button mdl-button--icon playerbutton">
        <i class="material-icons">pause</i>
      </button> -->
    </div>

  </div>



  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
  <script>
    window.mdc.autoInit();
    //TOOLS
    var getRequest = function (url, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.addEventListener('load', function (event) {
        var json = JSON.parse(xhr.responseText);
        callback(json);
      });
      xhr.send();
    }

    var postRequest = function (url, jsondata, callback) {
      var http = new XMLHttpRequest();
      http.open("POST", url, true);

      http.setRequestHeader("Content-type", "application/json");

      http.onreadystatechange = function () {
        if (http.readyState == 4) {
          callback(http.responseText);
        }
      }
      http.send(JSON.stringify(jsondata));
    }

    var deleteRequest = function (url, jsondata, callback) {
      var http = new XMLHttpRequest();
      http.open("DELETE", url, true);

      http.setRequestHeader("Content-type", "application/json");

      http.onreadystatechange = function () {
        if (http.readyState == 4) {
          callback(http.responseText);
        }
      }
      http.send(JSON.stringify(jsondata));
    }
    content = document.getElementById("content");
    function showDialog(heading, body, cancel, accept, oncancel, onaccept) {
      var dialog = document.createElement("aside");
      dialog.className = "mdc-dialog";
      dialog.role = "alertdialog";
      var surface = document.createElement("div");
      surface.className = "mdc-dialog__surface";
      var header = document.createElement("header");
      header.className = "mdc-dialog__header";
      var h2 = document.createElement("h2");
      h2.className = "mdc-dialog__header__title";
      var headertext = document.createTextNode(heading);
      var section = document.createElement("section");
      section.className = "mdc-dialog__body";
      var bodytext = document.createTextNode(body);
      var footer = document.createElement("footer");
      footer.className = "mdc-dialog__footer";
      var buttonCancel = document.createElement("button");
      buttonCancel.className = "mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--cancel";
      buttonCancel.type = "button";
      var buttonAccept = document.createElement("button");
      buttonAccept.className = "mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--accept";
      buttonAccept.type = "button";
      var backdrop = document.createElement("div");
      backdrop.className = "mdc-dialog__backdrop";
      var canceltext = document.createTextNode(cancel);
      var accepttext = document.createTextNode(accept);

      content.appendChild(dialog);
      dialog.appendChild(surface);
      surface.appendChild(header);
      header.appendChild(h2);
      h2.appendChild(headertext);
      surface.appendChild(section);
      section.appendChild(bodytext);
      surface.appendChild(footer);
      if (cancel != null) footer.appendChild(buttonCancel);
      if (accept != null) footer.appendChild(buttonAccept);
      buttonCancel.appendChild(canceltext);
      buttonAccept.appendChild(accepttext);
      dialog.appendChild(backdrop);
      var dialogjs = new mdc.dialog.MDCDialog(dialog);
      dialogjs.listen('MDCDialog:accept', onaccept);
      dialogjs.listen('MDCDialog:cancel', oncancel);
      dialogjs.show();
    }

    //DRAWER
    var drawerEl = document.querySelector('.mdc-temporary-drawer');
    var MDCTemporaryDrawer = mdc.drawer.MDCTemporaryDrawer;
    var drawer = new MDCTemporaryDrawer(drawerEl);
    document.querySelector('.menu').addEventListener('click', function () {
      drawer.open = true;
    });
    drawerEl.addEventListener('MDCTemporaryDrawer:open', function () {
      console.log('Received MDCTemporaryDrawer:open');
    });
    drawerEl.addEventListener('MDCTemporaryDrawer:close', function () {
      console.log('Received MDCTemporaryDrawer:close');
    });
    //TOOLBAR mdc-toolbar-fixed-adjust damit sich der adjust anpasst beim resizen
    window.addEventListener("resize", resize, true);


    function resize() {
      var toolbar = mdc.toolbar.MDCToolbar.attachTo(document.querySelector('.mdc-toolbar'));
      toolbar.fixedAdjustElement = document.querySelector('.mdc-toolbar-fixed-adjust');
    }
    var serverip = "http://10.0.0.16:1337/";

    //RADIO

    musikTabBar = new mdc.tabs.MDCTabBar(document.querySelector('.mdc-tab-bar'));
    senderSubPage = document.getElementById("sender");
    playlistSubPage = document.getElementById("playlist");
    musikTabBar.listen('MDCTabBar:change', function ({ detail: tabs }) {
      var tabIndex = tabs.activeTabIndex;
      if (tabIndex == 0) {
        senderSubPage.style.display = "block";
        playlistSubPage.style.display = "none";
      }
      else {
        senderSubPage.style.display = "none";
        playlistSubPage.style.display = "block";
      }
    });

    onOffAutoplay = document.getElementById("onOffAutoplay");
    onOffAutoplay.addEventListener("click", function () {
      var request = {};
      if (onOffAutoplay.checked) request.task = "Autoplayaktivieren";
      else request.task = "Autoplaydeaktivieren";;
      postRequest(serverip + "todo", request, function (msg) {
      });
    });



    var removedialog = new mdc.dialog.MDCDialog(document.querySelector('#removeRadiosenderDialog'));
    sender = document.getElementById("sender");
    var removeRadioBody = document.getElementById("removeRadioBody");

    var addRadio = function (name, nummer) {
      var formfield = document.createElement("div");
      formfield.className = "mdc-form-field";
      formfield.style.display = "flex"; //formfield hat sonst "display: inline-flex" und die sender werden horizontal gelistet

      var radio = document.createElement("div");
      radio.className = "mdc-radio";

      var input = document.createElement("input");
      input.type = "radio";
      input.id = "option-" + nummer;
      input.className = "mdc-radio__native-control";
      input.setAttribute("name", "options");
      input.value = "nummer";

      var radiobackground = document.createElement("div");
      radiobackground.className = "mdc-radio__background";

      var radiooutercircle = document.createElement("div");
      radiooutercircle.className = "mdc-radio__outer-circle";

      var radioinnercircle = document.createElement("div");
      radioinnercircle.className = "mdc-radio__inner-circle";

      var label = document.createElement("label");
      label.className = ""; //eventuell ripple einfügen
      label.setAttribute("for", "option-" + nummer);

      var node = document.createTextNode(name);

      label.appendChild(node);
      radiobackground.appendChild(radiooutercircle);
      radiobackground.appendChild(radioinnercircle);
      radio.appendChild(input);
      radio.appendChild(radiobackground);
      formfield.appendChild(radio);
      formfield.appendChild(label);
      sender.appendChild(formfield);

      //Rechte Maustaste
      formfield.addEventListener('contextmenu', function (e) {
        while (removeRadioBody.firstChild) {
          removeRadioBody.removeChild(removeRadioBody.firstChild);
        }
        var node = document.createTextNode('"' + name + '"' + " löschen?");
        removeRadioBody.appendChild(node);
        removedialog.show();
        e.preventDefault();
      }, false);

      input.onclick = (function () {
        var currentname = name;
        return function () {
          radiosenderSpielen(name);
        };
      })();
    }

    removedialog.listen('MDCDialog:accept', function () {
      removetext = removeRadioBody.childNodes[0].nodeValue;
      sendername = (removetext.split('"'))[1];
      request = {};
      request.name = sendername;
      deleteRequest(serverip + "Radiosender", request, function () {
      });
    });

    var radiosenderSpielen = function (name) {
      var request = {};
      request.task = "WebRadiospielen";
      request.name = name;
      console.log("abgesendeter request: " + JSON.stringify(request));
      postRequest(serverip + "todo", request, function (msg) {
        console.log(msg)
      });
    }

    //Radiosender hinzufügen
    var dialog = new mdc.dialog.MDCDialog(document.querySelector('#addRadiosenderDialog'));
    radioname = document.getElementById("radioname");
    radiourl = document.getElementById("radiourl");

    dialog.listen('MDCDialog:accept', function () {
      console.log('accepted');
      var request = {};
      request.name = radioname.value;
      request.url = radioname.value;
      postRequest(serverip + "Radiosender", request, function () {
        console.log("Radiosender hinzugefügt");
      });
    })

    document.querySelector('#addRadioButton').addEventListener('click', function (evt) {
      //dialog.lastFocusedTarget = evt.target;
      dialog.show();
    })

    //PLAYLIST
    playlist = document.getElementById("playlist");
    addPlaylistItems = function (status) {
      var songs = status.Playlist;
      if (songs != null) {
        for (var i = songs.length - 1; i >= 0; i--) {
          var songname = songs[i].Task.name;
          var listitem = document.createElement("li");
          var node = document.createTextNode(songname);
          listitem.appendChild(node);
          playlist.appendChild(listitem);
        }
      }
    }
    //PLAYLISTCONTROL
    mdc.textfield.MDCTextfield.attachTo(document.querySelector('#songinput'));

    stop = function () {
      var request = {};
      request.task = "Playerstoppen";
      postRequest(serverip + "todo", request, function (msg) {
        console.log(msg);
      });
    }

    playpausebuttonjs = new mdc.iconToggle.MDCIconToggle(document.getElementById("playpause"));

    const playpausebutton = document.getElementById('playpause');
    playpausebutton.addEventListener('MDCIconToggle:change', ({ detail }) => {
      var request = {};
      if (detail.isOn) request.task = "Playerpausieren";
      else request.task = "Playerfortsetzen";
      postRequest(serverip + "todo", request, function (msg) {
        console.log(msg);
      });
    });

    const SPACE_KEYCODE = 32;
    const ESCAPE_KEYCODE = 27;
    const ENTER_KEYCODE = 13;

    document.addEventListener("keyup", function (event) {
      var keyCode = event.which || event.keyCode || event.charCode;
      if (keyCode == SPACE_KEYCODE) {
        playpausebutton.click();
      }
      if (keyCode == ESCAPE_KEYCODE) {
        stop();
      }
    })

    songinputlabel = document.getElementById("songinputlabel");
    song = document.getElementById('song');
    song.addEventListener("keyup", function (event) {
      var keyCode = event.which || event.keyCode || event.charCode;
      if (keyCode == ENTER_KEYCODE) {
        addtoPlaylist();
      }
    });

    textinputs = document.getElementsByTagName("input");
    for (var i = 0; i < textinputs.length; i++) {
      textinputs[i].addEventListener("keyup", function (event) {
        var keyCode = event.which || event.keyCode || event.charCode;
        if (keyCode == SPACE_KEYCODE) {
          //Verhindert beim schreiben, dass pausiert wird
          event.stopPropagation();
          event.preventDefault();
          event.returnValue = false;
          event.cancelBubble = true;
        }
      });
    }

    videocheckbox = document.getElementById("video");
    nextCheckbox = document.getElementById("next");
    function addtoPlaylist() {
      var request = {};
      if (videocheckbox.checked) request.task = "YoutubeVideostreamen";
      else request.task = "YoutubeAudiostreamen";
      if (nextCheckbox.checked) request.next = true;
      else request.next = false;

      request.name = song.value;

      postRequest(serverip + "todo", request, function (msg) {
        console.log(msg);
      });

      song.value = "";
      //Fix, weil label (Song eingeben...) nicht wieder in die textbox geht, wenn man den button anklickt
      songinputlabel.classList.remove('mdc-textfield__label--float-above');
    }

    //ONLOAD
    update = function () {
      //Radiosender abrufen
      getRequest(serverip + "radiosender", function (res) {
        var i = 0;
        for (var sender in res) {
          addRadio(res[sender], i);
          i++;
        }
        //componentHandler.upgradeAllRegistered();
        //weil sonst manchmal kein mdl style auf den radio buttons ist...


        getRequest(serverip + "status", function (status) {
          //Bei wiedergabe pausebutton anzeigen und umgekehrt
          if (status.Pausiert == false) playpausebuttonjs.on = false;
          else playpausebuttonjs.on = true;
          //Spielenden Radio markieren
          if (status.task == "WebRadiospielen") {
            var senderliste = (document.getElementById("sender")).childNodes;
            for (var i = 0; i < senderliste.length; i++) {
              if (senderliste[i].childNodes[1] != undefined) {
                if ((senderliste[i].childNodes[1]).textContent == status.name) {
                  (senderliste[i].childNodes[0]).firstChild.checked = true;
                  break;
                }
              }
            }
          }
          addPlaylistItems(status);
        });
      });
    }
    update();

    var previousPageId = null;
    function showPage(pageid, button) {
      //Elemente von alter page verstecken
      if (previousPageId != null) {
        var previousPageElements = document.getElementsByClassName(previousPageId);
        for (var i = 0; i < previousPageElements.length; i++) {
          if (previousPageElements[i].classList.contains("tabs")) {
            if (screen.width <= 480) previousPageElements[i].style.display = "none";
          }
          else if (previousPageElements[i].parentElement.parentElement.tagName.toLowerCase() == "nav") {
            previousPageElements[i].classList.remove("mdc-permanent-drawer--selected");
          } else {
            previousPageElements[i].style.display = "none";
          }
        }
      }
      //Elemente von neuer page einblenden
      var pageElements = document.getElementsByClassName(pageid);
      for (var i = 0; i < pageElements.length; i++) {
        if (pageElements[i].classList.contains("tabs")) {
          if (screen.width <= 480) pageElements[i].style.display = "block";
        }
        else if (pageElements[i].parentElement.parentElement.tagName.toLowerCase() == "nav") {
          pageElements[i].classList.add("mdc-permanent-drawer--selected");
        }
        else {
          pageElements[i].style.display = "block";
        }
      }
      //Toolbar platzhalter aktualisieren (tabs können hinzugekommen/verschwunden sein)
      resize();
      previousPageId = pageid;
    }
    showPage("musik");
    //GERÄTE
    onOffKordel = document.getElementById("onOffKordel");
    onOffKordel.addEventListener("click", function () {
      if (!onOffKordel.checked) {
        var request = {};
        request.task = "Herunterfahren";
        postRequest(serverip + "todo", request, function (msg) {
          console.log(msg);
        });
      } else {
        showDialog("Befehl nicht möglich", "Kordel bitte manuell einschalten", null, "OK", null, null);
        onOffKordel.checked = false;
      }
    });
    onOffKordel.addEventListener("contextmenu", function (e) {
      if (onOffKordel.checked) {
        var request = {};
        request.task = "Neustarten";
        postRequest(serverip + "todo", request, function (msg) { });
        e.preventDefault();
      }
    });
  </script>
</body>